# IRQ

IRQ stands for Interrupt Request. It's a signal sent to the CPU by a hardware device or software to indicate that it requires the CPU's attention. Interrupts are a crucial part of how modern processors handle various events and manage tasks asynchronously, ensuring that the system can respond to external and internal events without having to constantly check for them (polling).

## Key concepts behind IRQs

### Interrupts

An interrupt is a mechanism that temporarily halts the CPU's current tasks, saves its state, and then executes a specific function or piece of code to deal with the event that caused the interrupt.

After the interrupt handler has completed, the CPU resumes the task it was working on before the interrupt occurred.

### Interrupt Request (IRQ)

An IRQ is the signal generated by hardware or software to request an interrupt. It essentially asks the CPU to stop what it's doing and process the interrupt.

IRQs can be triggered by hardware devices (keyboard input, network card events etc.) or software (operating system services etc.)

### Interrupt Handlers

Every IRQ has a handler associated with it. The handler is a piece of code that gets executed when the corresponding interrupt occurs.

For hardware interrupts, the handler typically involves reading or processing data from the device that caused the interrupt.

For software interrupts, the handler could perform tasks like system calls, scheduling etc.

### Interrupt Priority

Interrupts are often prioritized. Some IRQs (like the timer interrupt) may be more important and time-sensitive than others (like a keyboard input), and therefore, they may be assigned higher priority.

### Programmable Interrupt Controller (PIC)

Historically, on x86 systems, [PICs](pic.md) were used to manage interrupt requests. The PIC is responsible for receiving and managing IRQs from external devices and sending them to the CPU. It helps manage priorities and makes sure that only one interrupt is handled at a time.

### Common IRQs in x86 Architecture

| IRQ Number | Interrupt Source         | Vector (in IDT) |
| ---------- | ------------------------ | --------------- |
| IRQ 0      | System Timer (PIT)       | 0x20            |
| IRQ 1      | Keyboard                 | 0x21            |
| IRQ 2      | Cascade for second PIC   | 0x22            |
| IRQ 3      | Serial Port 2 (COM2)     | 0x23            |
| IRQ 4      | Serial Port 1 (COM1)     | 0x24            |
| IRQ 5      | Parallel Port 2          | 0x25            |
| IRQ 6      | Floppy Disk Controller   | 0x26            |
| IRQ 7      | Parallel Port 1          | 0x27            |
| IRQ 8      | Real-Time Clock (RTC)    | 0x28            |
| IRQ 9      | Available                | 0x29            |
| IRQ 10     | Available                | 0x2A            |
| IRQ 11     | Available                | 0x2B            |
| IRQ 12     | PS/2 Mouse               | 0x2C            |
| IRQ 13     | Math Coprocessor (FPU)   | 0x2D            |
| IRQ 14     | Primary IDE Hard Drive   | 0x2E            |
| IRQ 15     | Secondary IDE Hard Drive | 0x2F            |

### IRQ test functions

	void irq_test_49(void);
	void irq_test_33(void);
	void irq_test_32(void);
	bool irq_test_enabled(void);

`irq_test_32` triggers IRQ 0. This is the timer interrupt, which on most x86 systems is typically responsible for generating an interrupt at a fixed interval to handle time-sharing and other periodic tasks.

`irq_test_33` triggers IRQ 1 (keyboard interrupt).

`irq_test_49` would be a user-defined IRQ.

	bool irq_test_enabled(void) {
		unsigned long flags;
		__asm__ __volatile__("pushf\n\t" "pop %0" : "=g"(flags));
		return flags & (1 << 9);
	}

`irq_test_enabled` checks whether interrupts are enabled in the CPU by inspecting the Interrupt Flag (IF bit) in the Flags Register (EFLAGS).

If IF = 1, interrupts are enabled.
If IF = 0, interrupts are disabled, ant no IRQs will be handled.

*The Flags Register (EFLAGS in x86 systems) is a 32-bit register in the CPU that contains status flags used to store the results of operations, control flags, and certain state information.*